<div class="requisition-container">
  <!-- SINGLE ROW CONTROLS -->
  <div class="single-row-controls">
    <!-- Table Management -->
    <div class="control-section">
      <div class="table-management-compact">
        <select class="form-select-sm" [(ngModel)]="selectedTableId" (change)="loadTableData()">
          <option value="">-- Select Table --</option>
          @for (table of userTables; track table.id) {
            <option [value]="table.id">{{ table.name }}</option>
          }
        </select>
        <button class="btn-sm btn-icon" (click)="createNewTable()" title="New Table">
          <i class="fas fa-plus"></i>
        </button>
        <button class="btn-sm btn-icon" [disabled]="!selectedTableId" (click)="renameTable()" title="Rename">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn-sm btn-danger" [disabled]="!selectedTableId" (click)="deleteTable()" title="Delete">
          <i class="fas fa-trash"></i>
        </button>
        @if (selectedTableId) {
          @if (currentTable?.status === 'rejected') {
            <button class="btn-sm btn-primary" [disabled]="!canSubmitTable()" (click)="submitTableForApproval()" title="Resubmit Table">
              <i class="fas fa-redo"></i> Resubmit
            </button>
          } @else if (currentTable?.status === 'draft') {
            <button class="btn-sm btn-primary" [disabled]="!canSubmitTable()" (click)="submitTableForApproval()" title="Submit Table">
              <i class="fas fa-paper-plane"></i> Submit
            </button>
          }
        }
        <!-- Cut-off Schedule Button -->
        <button class="btn-sm btn-secondary" (click)="viewCutOffSchedule()" title="Cut-off Schedule">
          <i class="fas fa-calendar-alt"></i> Schedule
        </button>
      </div>
    </div>

    <!-- Admin Approvals -->
    @if (isAdmin) {
      <div class="control-section">
        <div class="admin-controls">
          <button class="btn-sm btn-warning" (click)="viewPendingApprovals()" title="Pending Approvals">
            <i class="fas fa-tasks"></i> Approvals
            @if (pendingApprovalsCount > 0) {
              <span class="badge">{{ pendingApprovalsCount }}</span>
            }
          </button>
        </div>
      </div>
    }

    <!-- Actions -->
    <div class="control-section">
      <div class="action-buttons-compact">
        <div class="dropdown">
          <button class="btn-sm btn-icon" [disabled]="requisitionItems.length === 0" (click)="toggleExportDropdown()" title="Export">
            <i class="fas fa-download"></i> Export
          </button>
          @if (isExportDropdownOpen) {
            <div class="dropdown-menu">
              <button type="button" (click)="exportData('all')"><i class="fas fa-file-excel"></i> All Data</button>
              <button type="button" (click)="exportData('perishable')"><i class="fas fa-carrot"></i> Perishable</button>
              <button type="button" (click)="exportData('shelf-stable')"><i class="fas fa-box"></i> Shelf-Stable</button>
            </div>
          }
        </div>
        <button class="btn-sm btn-danger" (click)="clearAll()" [disabled]="!selectedTableId || !isTableEditable()" title="Clear Table">
          <i class="fas fa-trash"></i> Clear
        </button>
        <!-- PO Receipts Button -->
        <button class="btn-sm btn-info" (click)="viewPOReceipts()" [disabled]="!selectedTableId" title="PO Receipts">
          <i class="fas fa-receipt"></i> PO Receipts
        </button>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  @if (currentTable?.status === 'submitted') {
    <div class="status-bar info">
      <i class="fas fa-hourglass-half"></i>
      <span>This table is submitted for approval (Submitted by {{ currentTable?.submittedBy }} on {{ currentTable?.submittedDate | date:'medium' }})</span>
    </div>
  }
  @if (currentTable?.status === 'approved') {
    <div class="status-bar success">
      <i class="fas fa-check-circle"></i>
      <span>This table is approved (Approved by {{ currentTable?.approvedBy }} on {{ currentTable?.approvedDate | date:'medium' }})</span>
    </div>
  }
  @if (currentTable?.status === 'rejected') {
    <div class="status-bar warning">
      <i class="fas fa-times-circle"></i>
      <span>This table is rejected (Rejected by {{ currentTable?.reviewedBy }} on {{ currentTable?.reviewedDate | date:'medium' }})</span>
      @if (currentTable?.remarks) {
        <span class="remarks">Reason: {{ currentTable?.remarks }}</span>
      }
    </div>
  }

  <!-- Cut-off Warning -->
  @if (isPastCutOff()) {
    <div class="status-bar error">
      <i class="fas fa-exclamation-triangle"></i>
      <span>⚠️ Past cut-off schedule! Requisitions submitted now may not be processed until next cycle.</span>
    </div>
  }

  <div class="status-bar">
    <span class="stats">
      <i class="fas fa-table"></i> {{ currentTable?.name || 'No table selected' }}
      <span class="divider">•</span>
      <i class="fas fa-list"></i> {{ filteredItems.length }} requisitions
      <span class="divider">•</span>
      <i class="fas fa-database"></i> Auto-saved
      @if (unservedCount > 0) {
        <span class="divider">•</span>
        <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
        <span style="color: #dc3545;">{{ unservedCount }} unserved</span>
      }
    </span>
    @if (requisitionItems.length > itemsPerPage) {
      <span class="pagination-mini">
        <button type="button" class="btn-xs" (click)="changePage(-1)" [disabled]="currentPage === 1">
          <i class="fas fa-chevron-left"></i>
        </button>
        <span>Page {{ currentPage }}/{{ totalPages }}</span>
        <button type="button" class="btn-xs" (click)="changePage(1)" [disabled]="currentPage === totalPages">
          <i class="fas fa-chevron-right"></i>
        </button>
      </span>
    }
  </div>

  <!-- Admin Approval Panel -->
  @if (showApprovalPanel && isAdmin) {
    <div class="modal-overlay" (click)="closeApprovalPanel()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3><i class="fas fa-tasks"></i> Pending Approvals ({{ pendingApprovalsCount }})</h3>
          <button type="button" class="modal-close" (click)="closeApprovalPanel()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          @if (pendingApprovals.length === 0) {
            <div class="empty-approvals">
              <i class="fas fa-check-circle"></i>
              <p>No pending approvals</p>
            </div>
          } @else {
            <div class="approval-list">
              @for (table of pendingApprovals; track table.id) {
                <div class="approval-item">
                  <div class="approval-info">
                    <strong>{{ table.name }}</strong>
                    <div class="approval-details">
                      <span>Submitted by: {{ table.submittedBy }}</span>
                      <span>Date: {{ table.submittedDate | date:'medium' }}</span>
                      <span>Items: {{ table.itemCount }}</span>
                      <span>Date Needed: {{ table.dateNeeded ? (table.dateNeeded | date:'shortDate') : 'Not specified' }}</span>
                    </div>
                  </div>
                  <div class="approval-actions">
                    <button type="button" class="btn-xs btn-primary" (click)="viewTableDetails(table.id)">
                      <i class="fas fa-eye"></i> View
                    </button>
                    <button type="button" class="btn-xs btn-success" (click)="approveTable(table.id)">
                      <i class="fas fa-check"></i> Approve
                    </button>
                    <button type="button" class="btn-xs btn-danger" (click)="rejectTable(table.id)">
                      <i class="fas fa-times"></i> Reject
                    </button>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      </div>
    </div>
  }

  <!-- Cut-off Schedule Modal -->
  @if (showCutOffSchedule) {
    <div class="modal-overlay" (click)="closeCutOffSchedule()">
      <div class="modal-content modal-md" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3><i class="fas fa-calendar-alt"></i> Cut-off Schedule</h3>
          <button type="button" class="modal-close" (click)="closeCutOffSchedule()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="cutoff-info">
            <h5><i class="fas fa-info-circle"></i> Current Schedule</h5>
            <div class="schedule-details">
              <div class="schedule-item">
                <strong>Perishable Items:</strong> <span>Every Monday & Thursday, 10:00 AM</span>
              </div>
              <div class="schedule-item">
                <strong>Shelf-Stable Items:</strong> <span>Every Wednesday, 2:00 PM</span>
              </div>
              <div class="schedule-item">
                <strong>Next Cut-off:</strong> <span>{{ getNextCutOffDate() | date:'fullDate' }} at {{ getNextCutOffTime() }}</span>
              </div>
              <div class="schedule-item">
                <strong>Delivery Lead Time:</strong> <span>2-3 business days after approval</span>
              </div>
            </div>
            <div class="cutoff-status">
              <div class="status-indicator" [class.past]="isPastCutOff()" [class.valid]="!isPastCutOff()">
                <i class="fas" [class.fa-check-circle]="!isPastCutOff()" [class.fa-exclamation-circle]="isPastCutOff()"></i>
                <span>{{ isPastCutOff() ? 'Past Cut-off Time' : 'Within Cut-off Schedule' }}</span>
              </div>
            </div>
            @if (isAdmin) {
              <div class="admin-cutoff-controls">
                <h5><i class="fas fa-cog"></i> Admin Settings</h5>
                <div class="form-group">
                  <label>Adjust Cut-off Time (Hours)</label>
                  <input type="number" [(ngModel)]="cutOffAdjustmentHours" min="-24" max="24" class="form-control">
                </div>
                <button type="button" class="btn btn-primary btn-sm" (click)="updateCutOffSchedule()">
                  <i class="fas fa-save"></i> Update Schedule
                </button>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  }

  <!-- PO Receipts Modal -->
  @if (showPOReceiptsModal) {
    <div class="modal-overlay" (click)="closePOReceiptsModal()">
      <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3><i class="fas fa-receipt"></i> PO Receipts - {{ currentTable?.name }}</h3>
          <button type="button" class="modal-close" (click)="closePOReceiptsModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="po-receipts-container">
            <!-- No PO Warning -->
            <div class="no-po-warning" *ngIf="!hasPOReceipts()">
              <i class="fas fa-exclamation-triangle"></i>
              <h5>No PO Receipts Attached</h5>
              <p>⚠️ <strong>NO PO, NO DELIVERY POLICY:</strong> Materials cannot be delivered without attached PO receipts.</p>
              <button type="button" class="btn btn-primary" (click)="uploadPOReceipt()">
                <i class="fas fa-upload"></i> Upload PO Receipt
              </button>
            </div>

            <!-- PO Receipts List -->
            @if (poReceipts.length > 0) {
              <div class="po-receipts-list">
                <h5><i class="fas fa-file-invoice"></i> Attached PO Receipts</h5>
                <div class="receipts-grid">
                  @for (receipt of poReceipts; track receipt.id) {
                    <div class="receipt-card">
                      <div class="receipt-header">
                        <div class="receipt-info">
                          <h6>{{ receipt.poNumber }}</h6>
                          <span class="receipt-date">{{ receipt.receiptDate | date:'shortDate' }}</span>
                        </div>
                        <span class="receipt-status" [class]="receipt.status">
                          {{ receipt.status === 'verified' ? 'Verified' : 'Pending' }}
                        </span>
                      </div>
                      <div class="receipt-details">
                        <div class="detail"><strong>Supplier:</strong> {{ receipt.supplier }}</div>
                        <div class="detail"><strong>Amount:</strong> {{ receipt.amount | currency:'PHP' }}</div>
                        <div class="detail"><strong>Items:</strong> {{ receipt.itemCount }}</div>
                        @if (receipt.remarks) {
                          <div class="detail"><strong>Remarks:</strong> {{ receipt.remarks }}</div>
                        }
                      </div>
                      <div class="receipt-actions">
                        <button type="button" class="btn-xs btn-primary" (click)="viewReceiptFile(receipt)">
                          <i class="fas fa-eye"></i> View
                        </button>
                        <button type="button" class="btn-xs btn-secondary" (click)="downloadReceipt(receipt)">
                          <i class="fas fa-download"></i> Download
                        </button>
                        @if (isAdmin) {
                          <button type="button" class="btn-xs btn-success" [disabled]="receipt.status === 'verified'" (click)="verifyReceipt(receipt.id)">
                            <i class="fas fa-check"></i> Verify
                          </button>
                        }
                        <button type="button" class="btn-xs btn-danger" (click)="deleteReceipt(receipt.id)">
                          <i class="fas fa-trash"></i> Delete
                        </button>
                      </div>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Upload Area -->
            <div class="upload-area" *ngIf="!isUploading">
              <div class="upload-zone" (click)="fileInput.click()" [class.drag-over]="isDragOver"
                   (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">
                <i class="fas fa-cloud-upload-alt"></i>
                <h5>Upload PO Receipt</h5>
                <p>Drag & drop files or click to browse</p>
                <p class="file-types">Supported: PDF, JPG, PNG (Max: 10MB)</p>
                <input #fileInput type="file" (change)="onFileSelected($event)" multiple accept=".pdf,.jpg,.jpeg,.png" hidden>
              </div>
            </div>
            @if (isUploading) {
              <div class="upload-progress">
                <div class="progress">
                  <div class="progress-bar" [style.width.%]="uploadProgress"></div>
                </div>
                <p>Uploading... {{ uploadProgress }}%</p>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Filter Controls -->
  <div class="filter-controls">
    <div class="filter-row" [formGroup]="filterForm">
      <div class="filter-group">
        <i class="fas fa-search"></i>
        <input type="text" formControlName="search" placeholder="Search requisitions..." class="filter-input">
      </div>
      <div class="filter-group">
        <select formControlName="status" class="filter-select">
          @for (filter of statusFilters; track filter.value) {
            <option [value]="filter.value">{{ filter.label }}</option>
          }
        </select>
      </div>
      <div class="filter-group">
        <select formControlName="type" class="filter-select">
          @for (filter of typeFilters; track filter.value) {
            <option [value]="filter.value">{{ filter.label }}</option>
          }
        </select>
      </div>
      <div class="filter-group">
        <input type="date" formControlName="dateFrom" class="filter-date" placeholder="From Date">
      </div>
      <div class="filter-group">
        <input type="date" formControlName="dateTo" class="filter-date" placeholder="To Date">
      </div>
      <div class="filter-group">
        <select formControlName="unservedOnly" class="filter-select">
          <option value="false">All Materials</option>
          <option value="true">Unserved Only</option>
        </select>
      </div>
      <button type="button" class="btn-sm btn-secondary" (click)="filterForm.reset()">
        <i class="fas fa-times"></i> Clear Filters
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Left Panel: Add Requisition Form -->
    <div class="left-panel">
      <div class="form-card">
        <h3><i class="fas fa-plus-circle"></i> Add New Requisition</h3>
        <form [formGroup]="requisitionForm" (ngSubmit)="onSubmitRequisition()">
          <!-- Requisition Type -->
          <div class="form-group">
            <label>Requisition Type *</label>
            <div class="type-options">
              @for (type of requisitionTypes; track type.value) {
                <label class="type-option">
                  <input type="radio" formControlName="requisitionType" [value]="type.value">
                  <span class="type-label">{{ type.label }}</span>
                </label>
              }
            </div>
          </div>

          <!-- Category and SKU -->
          <div class="form-row">
            <div class="form-group">
              <label>Category *</label>
              <select class="form-control" formControlName="category" (change)="onCategoryChange()">
                <option value="">Select Category</option>
                @for (category of categories; track category) {
                  <option [value]="category">{{ category }}</option>
                }
              </select>
              @if (requisitionForm.get('category')?.invalid && requisitionForm.get('category')?.touched) {
                <small class="text-danger">Category is required</small>
              }
            </div>
            <div class="form-group">
              <label>SKU *</label>
              <select class="form-control" formControlName="sku" (change)="onSkuChange()" [disabled]="skus.length === 0">
                <option value="">Select SKU</option>
                @for (sku of skus; track sku.code) {
                  <option [value]="sku.name">{{ sku.name }}</option>
                }
              </select>
              @if (requisitionForm.get('sku')?.invalid && requisitionForm.get('sku')?.touched) {
                <small class="text-danger">SKU is required</small>
              }
            </div>
          </div>

          <!-- SKU Code (Readonly) -->
          <div class="form-group">
            <label>SKU Code</label>
            <input type="text" class="form-control" formControlName="skuCode" readonly>
          </div>

          <!-- Quantity and Unit -->
          <div class="form-row">
            <div class="form-group">
              <label>Quantity Needed *</label>
              <input type="number" class="form-control" formControlName="qtyNeeded" min="1" max="999">
              @if (requisitionForm.get('qtyNeeded')?.invalid && requisitionForm.get('qtyNeeded')?.touched) {
                <small class="text-danger">Quantity must be between 1 and 999</small>
              }
            </div>
            <div class="form-group">
              <label>Unit *</label>
              <select class="form-control" formControlName="unit">
                <option value="">Select Unit</option>
                @for (unit of units; track unit.value) {
                  <option [value]="unit.value">{{ unit.label }}</option>
                }
              </select>
              @if (requisitionForm.get('unit')?.invalid && requisitionForm.get('unit')?.touched) {
                <small class="text-danger">Unit is required</small>
              }
            </div>
          </div>

          <!-- Date Needed -->
          <div class="form-group">
            <label>Date Needed (Optional)</label>
            <input type="date" class="form-control" formControlName="dateNeeded" [min]="minDateNeeded">
            <small class="text-muted">Leave empty for ASAP delivery</small>
          </div>

          <!-- Supplier -->
          <div class="form-group">
            <label>Supplier *</label>
            <select class="form-control" formControlName="supplier" (change)="onSupplierChange()">
              <option value="">Select Supplier</option>
              @for (supplier of suppliers; track supplier) {
                <option [value]="supplier">{{ supplier }}</option>
              }
            </select>
            @if (requisitionForm.get('supplier')?.invalid && requisitionForm.get('supplier')?.touched) {
              <small class="text-danger">Supplier is required</small>
            }
            @if (showCustomSupplierField) {
              <div class="custom-input-group">
                <input type="text" [(ngModel)]="customSupplierInput" [ngModelOptions]="{standalone: true}" placeholder="Enter supplier name" class="form-control custom-input">
                <button type="button" class="btn-xs btn-primary" (click)="addCustomSupplier()" [disabled]="!customSupplierInput.trim()">Add</button>
              </div>
            }
          </div>

          <!-- Brand -->
          <div class="form-group">
            <label>Brand *</label>
            <select class="form-control" formControlName="brand" (change)="onBrandChange()">
              <option value="">Select Brand</option>
              @for (brand of brands; track brand) {
                <option [value]="brand">{{ brand }}</option>
              }
            </select>
            @if (requisitionForm.get('brand')?.invalid && requisitionForm.get('brand')?.touched) {
              <small class="text-danger">Brand is required</small>
            }
            @if (showCustomBrandField) {
              <div class="custom-input-group">
                <input type="text" [(ngModel)]="customBrandInput" [ngModelOptions]="{standalone: true}" placeholder="Enter brand name" class="form-control custom-input">
                <button type="button" class="btn-xs btn-primary" (click)="addCustomBrand()" [disabled]="!customBrandInput.trim()">Add</button>
              </div>
            }
          </div>

          <!-- Remarks -->
          <div class="form-group">
            <label>Remarks (Optional)</label>
            <textarea class="form-control" formControlName="remarks" rows="2" placeholder="Additional notes..."></textarea>
          </div>

          <!-- Submit Button -->
          <div class="form-footer">
            <button type="submit" class="btn btn-primary btn-block" [disabled]="!canAddRequisition()" [title]="getAddButtonTooltip()">
              <i class="fas fa-plus"></i> Add Requisition
            </button>
            <div class="error-info" *ngIf="!canAddRequisition()">
              <small class="text-muted">
                <i class="fas fa-info-circle"></i> Cannot add requisition because:
                <span *ngIf="!selectedTableId">• No table selected</span>
                <span *ngIf="!isTableEditable()">• Table is not editable</span>
                <span *ngIf="requisitionForm.invalid">• Form has validation errors</span>
                <span *ngIf="isPastCutOff()">• Past cut-off schedule</span>
                <span *ngIf="!hasPOReceipts() && currentTable?.status === 'approved'">• No PO receipts attached</span>
              </small>
            </div>
          </div>
        </form>
      </div>

      <!-- Cut-off Info Panel -->
      <div class="cutoff-info-panel">
        <h4><i class="fas fa-clock"></i> Cut-off Schedule</h4>
        <div class="cutoff-details">
          <div class="cutoff-item" [class.active]="requisitionForm.get('requisitionType')?.value === 'perishable'">
            <strong>Perishable:</strong> Mon & Thu, 10:00 AM
          </div>
          <div class="cutoff-item" [class.active]="requisitionForm.get('requisitionType')?.value === 'shelf-stable'">
            <strong>Shelf-Stable:</strong> Wed, 2:00 PM
          </div>
          <div class="cutoff-time">
            <strong>Next Cut-off:</strong> {{ getNextCutOffDate() | date:'shortDate' }}
          </div>
        </div>
        <div class="cutoff-status" [class.past]="isPastCutOff()">
          <i class="fas" [class.fa-check]="!isPastCutOff()" [class.fa-exclamation-triangle]="isPastCutOff()"></i>
          <span>{{ isPastCutOff() ? 'Past Cut-off Time' : 'Within Schedule' }}</span>
        </div>
      </div>
    </div>

    <!-- Right Panel: Requisitions List -->
    <div class="right-panel">
      <div class="table-card">
        <div class="table-header">
          <h3><i class="fas fa-clipboard-list"></i> Material Requisitions</h3>
          <div class="table-info">
            <span class="total-count">{{ requisitionItems.length }} total</span>
            @if (unservedCount > 0) {
              <span class="unserved-count">
                <i class="fas fa-exclamation-triangle"></i> {{ unservedCount }} unserved
              </span>
            }
            @if (!hasPOReceipts() && currentTable?.status === 'approved') {
              <span class="po-warning">
                <i class="fas fa-exclamation-circle"></i> No PO Receipts
              </span>
            }
          </div>
        </div>
        <div class="table-responsive">
          <table class="requisition-table">
            <thead>
              <tr>
                <th style="width:40px;"></th>
                <th class="sortable" (click)="sortBy('requisitionNumber')">Req #</th>
                <th class="sortable" (click)="sortBy('type')">Type</th>
                <th class="sortable" (click)="sortBy('dateNeeded')">Date Needed</th>
                <th class="sortable" (click)="sortBy('skuCode')">SKU Code</th>
                <th class="sortable" (click)="sortBy('skuName')">SKU Name</th>
                <th class="sortable" (click)="sortBy('qtyNeeded')">Qty</th>
                <th class="sortable" (click)="sortBy('supplier')">Supplier</th>
                <th class="sortable" (click)="sortBy('brand')">Brand</th>
                <th class="sortable" (click)="sortBy('status')">Status</th>
                <th style="width:100px;">Materials</th>
                <th style="width:80px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              @if (filteredItems.length === 0) {
                <tr>
                  <td colspan="12">
                    <div class="empty-state">
                      <i class="fas fa-inbox"></i>
                      <p>{{ searchQuery || filterForm.value.status || filterForm.value.type ? 'No matching requisitions found' : 'No requisitions added yet' }}</p>
                      @if (!selectedTableId) {
                        <p class="empty-hint">Select or create a table to start adding requisitions</p>
                      } @else if (currentTable?.status !== 'draft') {
                        <p class="empty-hint">Table is {{ currentTable?.status }}, cannot add new requisitions</p>
                      } @else if (isPastCutOff()) {
                        <p class="empty-hint">Past cut-off schedule. Requisitions will be processed next cycle.</p>
                      }
                    </div>
                  </td>
                </tr>
              }
              @for (item of filteredItems; track item.id) {
                <tr [class.expanded]="expandedRows.has(item.id)" [class.has-unserved]="hasUnservedMaterials(item)">
                  <td>
                    <button type="button" class="toggle-btn" (click)="toggleRow(item.id)">
                      <i class="fas" [class.fa-chevron-up]="expandedRows.has(item.id)" [class.fa-chevron-down]="!expandedRows.has(item.id)"></i>
                    </button>
                  </td>
                  <td><strong>{{ item.requisitionNumber }}</strong></td>
                  <td>
                    <span class="type-badge" [class]="item.type">
                      {{ item.type === 'perishable' ? 'Perishable' : 'Shelf-Stable' }}
                    </span>
                  </td>
                  <td>
                    @if (item.dateNeeded) {
                      <span class="date-needed" [class.past-due]="isDatePastDue(item.dateNeeded)">
                        {{ item.dateNeeded | date:'shortDate' }}
                        @if (isDatePastDue(item.dateNeeded)) {
                          <i class="fas fa-exclamation-triangle" title="Past due"></i>
                        }
                      </span>
                    } @else {
                      <span class="text-muted">ASAP</span>
                    }
                  </td>
                  <td><code>{{ item.skuCode }}</code></td>
                  <td>{{ item.skuName }}</td>
                  <td class="numeric">{{ item.qtyNeeded }} {{ item.unit }}</td>
                  <td>{{ item.supplier }}</td>
                  <td>{{ item.brand }}</td>
                  <td>
                    <span class="status-badge" [style.background-color]="getStatusColor(item.status)">
                      <i class="fas" [class]="getStatusIcon(item.status)"></i>
                      {{ item.status === 'draft' ? 'Draft' : item.status === 'submitted' ? 'Submitted' : item.status === 'approved' ? 'Approved' : item.status === 'rejected' ? 'Rejected' : item.status === 'partially-served' ? 'Partially Served' : 'Fully Served' }}
                    </span>
                  </td>
                  <td class="numeric">
                    {{ item.materials.length }}
                    @if (hasUnservedMaterials(item)) {
                      <span class="unserved-indicator" title="Has unserved materials">
                        <i class="fas fa-exclamation-circle" style="color: red;"></i>
                      </span>
                    }
                  </td>
                  <td>
                    <div class="action-buttons">
                      <button type="button" class="btn-icon btn-sm btn-primary" (click)="openAddMaterialModal(item.id)" [disabled]="!isTableEditable()" title="Add Material">
                        <i class="fas fa-plus"></i>
                      </button>
                      <button type="button" class="btn-icon btn-sm btn-danger" (click)="deleteRequisition(item.id)" [disabled]="!isTableEditable()" title="Delete">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>

                <!-- Expanded Details -->
                @if (expandedRows.has(item.id)) {
                  <tr class="details-row">
                    <td colspan="12">
                      <div class="details-content">
                        <!-- Materials List -->
                        <div class="materials-section">
                          <h5><i class="fas fa-boxes"></i> Materials ({{ item.materials.length }})</h5>
                          @if (item.materials.length === 0) {
                            <div class="no-materials">
                              <i class="fas fa-box-open"></i>
                              <p>No materials added yet. Click the plus button to add materials.</p>
                            </div>
                          } @else {
                            <div class="materials-grid">
                              @for (material of item.materials; track material.id) {
                                <div class="material-card" [class]="material.status" [class.unserved]="material.isUnserved">
                                  @if (material.isUnserved) {
                                    <div class="unserved-flag">
                                      <i class="fas fa-exclamation-triangle"></i> Unserved
                                    </div>
                                  }
                                  <div class="material-header">
                                    <div class="material-title">
                                      <h6>{{ material.name }}</h6>
                                      <span class="material-type">{{ material.type }}</span>
                                    </div>
                                    <span class="material-status" [style.background-color]="getMaterialStatusColor(material.status || 'pending')">
                                      {{ material.status === 'pending' ? 'Pending' : material.status === 'partially-served' ? 'Partially Served' : 'Fully Served' }}
                                    </span>
                                  </div>
                                  <div class="material-details">
                                    <div class="detail-row">
                                      <div class="detail"><span class="detail-label">Quantity:</span> <span class="detail-value">{{ material.qty }} {{ material.unit }}</span></div>
                                      <div class="detail"><span class="detail-label">Required:</span> <span class="detail-value">{{ material.requiredQty }} {{ material.unit }}</span></div>
                                      <div class="detail"><span class="detail-label">Brand:</span> <span class="detail-value">{{ material.brand || '-' }}</span></div>
                                      <div class="detail"><span class="detail-label">Supplier:</span> <span class="detail-value">{{ material.supplier || '-' }}</span></div>
                                    </div>
                                    <div class="served-section">
                                      <label>Served Quantity:</label>
                                      <div class="served-controls">
                                        <input type="number" class="served-input" [value]="material.servedQty || 0" min="0" [max]="material.requiredQty"
                                               (change)="updateMaterialServedQty(item.id, material.id, $any($event.target).value)" [disabled]="!isTableEditable()" [class.unserved-input]="material.isUnserved">
                                        <span class="unit-label">{{ material.unit }}</span>
                                        @if (material.servedDate) {
                                          <span class="served-date"><i class="fas fa-calendar"></i> {{ material.servedDate | date:'shortDate' }}</span>
                                        }
                                      </div>
                                      @if (material.isUnserved) {
                                        <div class="unserved-warning">
                                          <i class="fas fa-exclamation-triangle"></i>
                                          <span>Material not fully served</span>
                                        </div>
                                      }
                                    </div>
                                    @if (material.remarks) {
                                      <div class="material-remarks">
                                        <strong>Remarks:</strong> {{ material.remarks }}
                                      </div>
                                    }
                                  </div>
                                  <div class="material-actions">
                                    <button type="button" class="btn-xs btn-danger" (click)="deleteMaterial(item.id, material.id)" [disabled]="!isTableEditable()">
                                      <i class="fas fa-trash"></i> Remove
                                    </button>
                                  </div>
                                </div>
                              }
                            </div>
                          }
                        </div>

                        @if (item.remarks) {
                          <div class="requisition-remarks">
                            <strong><i class="fas fa-comment"></i> Requisition Remarks:</strong> {{ item.remarks }}
                          </div>
                        }

                        <!-- PO Receipts for this requisition -->
                        @if (item.status === 'approved') {
                          <div class="po-receipts-section">
                            <h6><i class="fas fa-receipt"></i> PO Receipts</h6>
                            @if (getPOReceiptsForRequisition(item.id).length === 0) {
                              <div class="no-po-warning-small">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>No PO receipts attached - Delivery may be delayed</span>
                              </div>
                            } @else {
                              <div class="po-receipts-mini">
                                @for (receipt of getPOReceiptsForRequisition(item.id); track receipt.id) {
                                  <span class="po-badge" [class.verified]="receipt.status === 'verified'">
                                    {{ receipt.poNumber }}
                                    @if (receipt.status === 'verified') { <i class="fas fa-check"></i> }
                                  </span>
                                }
                              </div>
                            }
                          </div>
                        }
                      </div>
                    </td>
                  </tr>
                }
              }
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        @if (requisitionItems.length > itemsPerPage) {
          <div class="pagination">
            <button type="button" class="btn-pagination" (click)="changePage(-1)" [disabled]="currentPage === 1">
              <i class="fas fa-chevron-left"></i> Previous
            </button>
            <span class="page-info">Page {{ currentPage }} of {{ totalPages }}</span>
            <button type="button" class="btn-pagination" (click)="changePage(1)" [disabled]="currentPage === totalPages">
              Next <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        }
      </div>
    </div>
  </div>

  <!-- Add Material Modal -->
  @if (showAddMaterialModal) {
    <div class="modal-overlay" (click)="closeAddMaterialModal()">
      <div class="modal-content modal-sm" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3><i class="fas fa-plus"></i> Add Material</h3>
          <button type="button" class="modal-close" (click)="closeAddMaterialModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form [formGroup]="materialForm" (ngSubmit)="addMaterial()">
            <div class="form-group">
              <label>Material Name *</label>
              <input type="text" class="form-control" formControlName="name" placeholder="Enter material name">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Type *</label>
                <select class="form-control" formControlName="type">
                  @for (type of materialTypes; track type.value) {
                    <option [value]="type.value">{{ type.label }}</option>
                  }
                </select>
              </div>
              <div class="form-group">
                <label>Unit *</label>
                <select class="form-control" formControlName="unit">
                  @for (unit of units; track unit.value) {
                    <option [value]="unit.value">{{ unit.label }}</option>
                  }
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Quantity *</label>
                <input type="number" class="form-control" formControlName="quantity" min="0.01" step="0.01">
              </div>
              <div class="form-group">
                <label>Required Qty *</label>
                <input type="number" class="form-control" formControlName="requiredQty" min="0.01" step="0.01">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Brand</label>
                <input type="text" class="form-control" formControlName="brand" placeholder="Optional">
              </div>
              <div class="form-group">
                <label>Supplier</label>
                <input type="text" class="form-control" formControlName="supplier" placeholder="Optional">
              </div>
            </div>
            <div class="form-group">
              <label>Remarks</label>
              <textarea class="form-control" formControlName="remarks" rows="2" placeholder="Optional remarks..."></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" (click)="closeAddMaterialModal()">Cancel</button>
              <button type="submit" class="btn btn-primary" [disabled]="materialForm.invalid">Add Material</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  }

  <!-- Snackbar -->
  @if (showSnackbar) {
    <div class="snackbar" [class]="'snackbar-' + snackbarType">
      <div class="snackbar-content">
        <i class="fas" [class]="getSnackbarIcon()"></i>
        <span class="snackbar-message">{{ snackbarMessage }}</span>
      </div>
      <button type="button" class="snackbar-close" (click)="hideSnackbar()">
        <i class="fas fa-times"></i>
      </button>
    </div>
  }
</div>