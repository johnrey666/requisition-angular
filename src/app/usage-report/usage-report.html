<div class="report-container">
  <!-- Header -->
  <div class="header">
    <h1>Raw Material Usage</h1>
    <p>View aggregated material usage across production tables</p>
  </div>

  <!-- Controls -->
  <div class="controls">
    <div class="control-group">
      <select [(ngModel)]="selectedTableId" (change)="loadUsageData()" class="select" [disabled]="isLoading">
        <option value="all">All Tables</option>
        <option *ngFor="let table of userTables" [value]="table.id">
          {{ table.name }} ({{ table.item_count || 0 }} items)
        </option>
      </select>
      
      <div class="actions">
        <button class="btn" (click)="loadUsageData()" [disabled]="isLoading">
          <span class="btn-icon">‚Üª</span>
          <span>{{ isLoading ? 'Loading...' : 'Refresh' }}</span>
        </button>
        <button class="btn primary" (click)="exportToExcel()" [disabled]="usageData.length === 0 || isLoading">
          <span class="btn-icon">üìä</span>
          <span>Export</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="state loading">
    <div class="spinner"></div>
    <p>Loading usage data...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && usageData.length === 0" class="state empty">
    <div class="icon">üìä</div>
    <h3>No Usage Data Found</h3>
    <p>No material usage data available for the selected criteria.</p>
    <p *ngIf="selectedTableId === 'all'" class="hint">Try selecting a specific table or adding requisitions to tables.</p>
    <button class="btn" (click)="loadUsageData()">
      <span class="btn-icon">‚Üª</span>
      <span>Try Again</span>
    </button>
  </div>

  <!-- Content -->
  <div *ngIf="!isLoading && usageData.length > 0">
    <!-- Summary -->
    <div class="summary">
      <div class="stat">
        <div class="stat-value">{{ totalMaterials }}</div>
        <div class="stat-label">Materials</div>
      </div>
      <div class="stat">
        <div class="stat-value">{{ totalQuantity | number:'1.2-2' }}</div>
        <div class="stat-label">Total Qty</div>
      </div>
      <div class="stat">
        <div class="stat-value">{{ totalTables }}</div>
        <div class="stat-label">Tables</div>
      </div>
      <div class="stat">
        <div class="stat-value">{{ usageData.length }}</div>
        <div class="stat-label">Records</div>
      </div>
    </div>

    <!-- Table -->
    <div class="table-container">
      <div class="table-header">
        <h3>Material Summary</h3>
        <div class="table-info">{{ paginatedData.length }} of {{ usageData.length }} materials</div>
      </div>
      
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th (click)="sortData('material_name')">
                <span>Material</span>
                <span class="sort-icon" *ngIf="sortField === 'material_name'">
                  {{ sortAsc ? '‚Üë' : '‚Üì' }}
                </span>
              </th>
              <th (click)="sortData('material_type')">
                <span>Type</span>
                <span class="sort-icon" *ngIf="sortField === 'material_type'">
                  {{ sortAsc ? '‚Üë' : '‚Üì' }}
                </span>
              </th>
              <th (click)="sortData('unit')">
                <span>Unit</span>
                <span class="sort-icon" *ngIf="sortField === 'unit'">
                  {{ sortAsc ? '‚Üë' : '‚Üì' }}
                </span>
              </th>
              <th (click)="sortData('total_quantity')">
                <span>Quantity</span>
                <span class="sort-icon" *ngIf="sortField === 'total_quantity'">
                  {{ sortAsc ? '‚Üë' : '‚Üì' }}
                </span>
              </th>
              <th (click)="sortData('table_count')">
                <span>Tables</span>
                <span class="sort-icon" *ngIf="sortField === 'table_count'">
                  {{ sortAsc ? '‚Üë' : '‚Üì' }}
                </span>
              </th>
              <th (click)="sortData('sku_count')">
                <span>SKUs</span>
                <span class="sort-icon" *ngIf="sortField === 'sku_count'">
                  {{ sortAsc ? '‚Üë' : '‚Üì' }}
                </span>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of paginatedData">
              <td class="material">{{ item.material_name }}</td>
              <td>
                <span class="tag" [class]="getTypeClass(item.material_type)">
                  {{ item.material_type }}
                </span>
              </td>
              <td>{{ item.unit }}</td>
              <td class="quantity">{{ item.total_quantity | number:'1.2-2' }}</td>
              <td>
                <div class="count">
                  <span>{{ item.table_count }}</span>
                  <span *ngIf="item.tables.length > 0" class="info" [title]="item.tables.join(', ')">‚ìò</span>
                </div>
              </td>
              <td>
                <div class="count">
                  <span>{{ item.sku_count }}</span>
                  <span *ngIf="item.skus.length > 0" class="info" [title]="item.skus.join('\n')">‚ìò</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div *ngIf="totalPages > 1" class="pagination">
        <button (click)="previousPage()" [disabled]="currentPage === 1">
          <span>‚Üê</span>
        </button>
        <span class="page">Page {{ currentPage }} of {{ totalPages }}</span>
        <button (click)="nextPage()" [disabled]="currentPage === totalPages">
          <span>‚Üí</span>
        </button>
      </div>
    </div>

    <!-- Breakdown -->
    <div class="breakdown">
      <div class="breakdown-header">
        <h3>Type Breakdown</h3>
        <div class="breakdown-info">{{ typeBreakdown.length }} categories</div>
      </div>
      
      <div class="breakdown-wrapper">
        <table>
          <thead>
            <tr>
              <th>Type</th>
              <th>Materials</th>
              <th>Quantity</th>
              <th>%</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let breakdown of typeBreakdown">
              <td>
                <span class="tag" [class]="getTypeClass(breakdown.type)">
                  {{ breakdown.type }}
                </span>
              </td>
              <td>{{ breakdown.material_count }}</td>
              <td>{{ breakdown.total_quantity | number:'1.2-2' }}</td>
              <td>
                <div class="percentage">
                  <div class="bar">
                    <div class="fill" [style.width.%]="breakdown.percentage"></div>
                  </div>
                  <span class="value">{{ breakdown.percentage | number:'1.1-1' }}%</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div *ngIf="showSnackbar" class="notification" [class]="'notification-' + snackbarType">
    <div class="notification-content">
      <span class="notification-icon">{{ getSnackbarIcon() }}</span>
      <span>{{ snackbarMessage }}</span>
    </div>
    <button class="notification-close" (click)="hideSnackbar()">√ó</button>
  </div>
</div>