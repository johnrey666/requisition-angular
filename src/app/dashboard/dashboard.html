<div class="dashboard-container">
  <div class="header">
    <div class="header-left">
      <h2><i class="fas fa-industry"></i> Raw Material E-Portal</h2>
      <div class="user-info">
        <span class="user-role" [class.admin]="isAdmin" [class.user]="!isAdmin">
          <i class="fas" [class.fa-user-shield]="isAdmin" [class.fa-user]="!isAdmin"></i>
          {{ currentUser?.full_name || currentUser?.username || currentUser?.email }}
          <span class="role-badge">{{ isAdmin ? 'Admin' : 'User' }}</span>
        </span>
      </div>
    </div>

    <div class="header-actions">
      <button id="darkModeBtn" (click)="toggleDarkMode()" [title]="darkMode ? 'Light Mode' : 'Dark Mode'">
        <i class="fas" [class.fa-sun]="darkMode" [class.fa-moon]="!darkMode"></i>
      </button>
      <button id="printBtn" (click)="window.print()" title="Print Table">
        <i class="fas fa-print"></i>
      </button>
      <button id="logoutBtn" (click)="logout()" title="Logout">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </div>

  <div class="upload-section">
    <div class="upload-box">
      <input type="file" #masterFileInput id="masterFile" accept=".xlsx, .xls"
             (change)="onFileUpload($event)" style="display: none">
      <button class="btn-upload" (click)="masterFileInput.click()">
        <i class="fas fa-upload"></i> Upload Master File
      </button>
      <span class="upload-status" [class.has-file]="uploadedFileName">
        {{ uploadedFileName || 'No file uploaded' }}
      </span>
      @if (uploadedFileName) {
        <button class="btn-clear-file" (click)="clearFile()" title="Clear uploaded file">
          <i class="fas fa-times"></i>
        </button>
      }

      <div class="cloud-section">
        <button id="configBtn" title="View Config">
          <i class="fas fa-cog"></i>
        </button>

        <button id="syncBtn" (click)="toggleSync()"
                [class.synced]="isSyncEnabled" [class.offline]="!isSyncEnabled"
                [title]="isSyncEnabled ? 'Disable cloud sync' : 'Enable cloud sync'">
          <i class="fas" [class.fa-cloud-upload-alt]="isSyncEnabled" [class.fa-cloud-slash]="!isSyncEnabled"></i>
          <span>{{ isSyncEnabled ? 'Synced' : 'Offline' }}</span>
        </button>

        <button id="restoreBtn" (click)="restoreFromCloud()" title="Restore from cloud">
          <i class="fas fa-cloud-download-alt"></i>
          <span>Restore</span>
        </button>

        <span class="sync-status">{{ syncStatus }}</span>
      </div>
    </div>
  </div>

  <div class="controls-section">
    <div class="form-controls">
      <form [formGroup]="requisitionForm" class="form-row">
        <select id="categorySelect"
                formControlName="category"
                (change)="onCategoryChange()"
                class="form-select">
          <option value="">-- Category --</option>
          @for (category of categories; track category) {
            <option [value]="category">{{ category }}</option>
          }
        </select>

        <select id="skuSelect"
                formControlName="sku"
                (change)="onSkuChange()"
                [disabled]="skus.length === 0"
                class="form-select">
          <option value="">-- SKU --</option>
          @for (sku of skus; track sku.code) {
            <option [value]="sku.name">{{ sku.name }} ({{ sku.code }})</option>
          }
        </select>

        <input type="text"
               formControlName="skuCode"
               placeholder="Code"
               readonly
               class="form-input">

        <input type="text"
               formControlName="supplier"
               placeholder="Supplier"
               class="form-input">

        <button type="button"
                (click)="addRequisition()"
                [disabled]="requisitionForm.invalid"
                class="btn-primary">
          <i class="fas fa-plus"></i> Add
        </button>
      </form>
    </div>

    <div class="action-controls">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" [(ngModel)]="searchQuery"
               (ngModelChange)="onSearch()" placeholder="Search Code/SKU/Category..."
               class="search-input">
      </div>

      <div class="export-dropdown">
        <button class="btn-export" (click)="toggleExportDropdown()"
                [disabled]="requisitionItems.length === 0">
          <i class="fas fa-download"></i> Export
        </button>

        @if (isExportDropdownOpen) {
          <div class="export-options">
            <button (click)="exportData('all')">
              <i class="fas fa-file-excel"></i> Export All Data
            </button>
            <button (click)="exportData('pre-mix')">
              <i class="fas fa-flask"></i> Export Pre-mix Only
            </button>
            <button (click)="exportData('packaging')">
              <i class="fas fa-box"></i> Export Packaging Only
            </button>
            <button (click)="exportData('meat-veg')">
              <i class="fas fa-carrot"></i> Export Meat & Vegetables Only
            </button>
          </div>
        }
      </div>

      <button id="clearBtn" (click)="clearAll()" class="btn-danger">
        <i class="fas fa-trash"></i> Clear All
      </button>
    </div>
  </div>

  @if (!isSubmissionAllowed) {
    <div class="cutoff-warning">
      <i class="fas fa-clock"></i>
      <span>Submission is currently disabled. Next submission window: Tomorrow 08:00 AM</span>
    </div>
  }

  <div class="table-container">
    <table class="main-table">
      <thead>
        <tr>
          <th style="width:40px;"></th>
          <th class="sortable" (click)="sortBy('skuCode')" [class.sort-asc]="sortField === 'skuCode' && sortAsc" [class.sort-desc]="sortField === 'skuCode' && !sortAsc">
            Code <i class="fas fa-sort sort-icon"></i>
          </th>
          <th class="sortable" (click)="sortBy('skuName')" [class.sort-asc]="sortField === 'skuName' && sortAsc" [class.sort-desc]="sortField === 'skuName' && !sortAsc">
            SKU <i class="fas fa-sort sort-icon"></i>
          </th>
          <th class="sortable" (click)="sortBy('category')" [class.sort-asc]="sortField === 'category' && sortAsc" [class.sort-desc]="sortField === 'category' && !sortAsc">
            Category <i class="fas fa-sort sort-icon"></i>
          </th>
          <th style="width:80px;">Qty</th>
          <th style="width:140px;">Supplier</th>
          <th style="width:90px;">Qty/Unit</th>
          <th style="width:70px;">Unit</th>
          <th style="width:90px;">Qty/Pack</th>
          <th style="width:70px;">Pack Unit</th>
          <th style="width:60px;">Mats</th>
          <th style="width:120px;">Status</th>
          <th style="width:80px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        @if (filteredItems.length === 0) {
          <tr class="no-data">
            <td colspan="13">
              <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>{{ searchQuery ? 'No results found' : 'No requisitions added yet' }}</p>
                @if (!uploadedFileName) {
                  <p class="upload-hint">Upload a master file to start adding requisitions</p>
                }
              </div>
            </td>
          </tr>
        }

        @for (item of filteredItems; track item.id; let i = $index) {
          <tr [class.expanded]="expandedRows.has(item.id)">
            <td>
              <button class="toggle-btn" (click)="toggleRow(item.id)"
                      [title]="expandedRows.has(item.id) ? 'Collapse' : 'Expand'">
                <i class="fas" [class.fa-chevron-up]="expandedRows.has(item.id)" [class.fa-chevron-down]="!expandedRows.has(item.id)"></i>
              </button>
            </td>
            <td><strong>{{ item.skuCode }}</strong></td>
            <td>{{ item.skuName }}</td>
            <td><span class="category-badge">{{ item.category }}</span></td>
            <td>
              <input type="number" class="qty-input" min="1" max="99"
                     [value]="item.qtyNeeded"
                     (change)="updateQty(item.id, $any($event.target).value)"
                     [disabled]="item.status !== 'draft'">
            </td>
            <td>
              <input type="text" class="supplier-input"
                     [value]="item.supplier"
                     (change)="updateSupplier(item.id, $any($event.target).value)"
                     placeholder="Enter supplier"
                     [disabled]="item.status !== 'draft'">
            </td>
            <td class="numeric">{{ item.qtyPerUnit || '-' }}</td>
            <td>{{ item.unit || '-' }}</td>
            <td class="numeric">{{ item.qtyPerPack || '-' }}</td>
            <td>{{ item.unit2 || '-' }}</td>
            <td class="numeric">{{ item.materials.length }}</td>
            <td>
              <span class="status-badge" [class]="item.status">
                <i class="fas" [class]="getStatusIcon(item.status)"></i>
                {{ item.status | titlecase }}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                @if (item.status === 'draft') {
                  <button class="btn-submit" (click)="submitRequisition(item.id)"
                          [disabled]="!isSubmissionAllowed" title="Submit for approval">
                    <i class="fas fa-paper-plane"></i>
                  </button>
                }

                @if (isAdmin && item.status === 'submitted') {
                  <button class="btn-approve" (click)="reviewRequisition(item.id, true)" title="Approve">
                    <i class="fas fa-check"></i>
                  </button>
                  <button class="btn-reject" (click)="reviewRequisition(item.id, false)" title="Reject">
                    <i class="fas fa-times"></i>
                  </button>
                }

                <button class="btn-delete" (click)="deleteItem(item.id)" title="Delete"
                        [disabled]="item.status !== 'draft' && !isAdmin">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>

          @if (expandedRows.has(item.id)) {
            <tr class="expanded-row">
              <td colspan="13">
                <div class="materials-details">
                  <div class="details-header">
                    <h4><i class="fas fa-list"></i> Raw Materials for {{ item.skuName }}</h4>
                    <div class="type-filter">
                      <select class="type-select" #typeFilter (change)="filterMaterials(item.id, typeFilter.value)">
                        <option value="">All Types</option>
                        <option value="pre-mix">Pre-mix</option>
                        <option value="packaging">Packaging</option>
                        <option value="meat-veg">Meat & Vegetables</option>
                      </select>
                    </div>
                  </div>

                  <table class="materials-table">
                    <thead>
                      <tr>
                        <th>Raw Material</th>
                        <th>Qty/Batch</th>
                        <th>Unit</th>
                        <th>Type</th>
                        <th>Required Qty</th>
                        <th>Served Qty</th>
                        <th>Remarks</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (material of getFilteredMaterials(item.id, item.materials); track $index) {
                        <tr [class.unserved]="material.isUnserved">
                          <td><strong>{{ material.name }}</strong></td>
                          <td class="numeric">{{ material.qty }}</td>
                          <td>{{ material.unit }}</td>
                          <td>
                            <span class="type-badge">{{ material.type || 'N/A' }}</span>
                          </td>
                          <td class="numeric">{{ material.requiredQty }} {{ material.unit }}</td>
                          <td>
                            <input type="number" class="served-input"
                                   [value]="material.servedQty || 0"
                                   min="0" [max]="material.requiredQty"
                                   (change)="updateMaterialServedQty(item.id, $index, $any($event.target).value)"
                                   [disabled]="item.status === 'draft'">
                          </td>
                          <td>
                            <input type="text" class="remarks-input"
                                   [value]="material.remarks || ''"
                                   placeholder="Remarks"
                                   (change)="updateMaterialServedQty(item.id, $index, material.servedQty || 0, $any($event.target).value)"
                                   [disabled]="item.status === 'draft'">
                          </td>
                          <td>
                            @if (material.isUnserved) {
                              <span class="unserved-badge">
                                <i class="fas fa-exclamation-triangle"></i> Unserved
                              </span>
                            } @else if (material.servedQty && material.servedQty > 0) {
                              <span class="served-badge">
                                <i class="fas fa-check"></i> Served
                                @if (material.servedDate) {
                                  <small>{{ material.servedDate | date:'shortDate' }}</small>
                                }
                              </span>
                            } @else {
                              <span class="pending-badge">
                                <i class="fas fa-clock"></i> Pending
                              </span>
                            }
                          </td>
                          <td>
                            <button class="btn-save"
                                    (click)="updateMaterialServedQty(item.id, $index, material.servedQty || 0, material.remarks)"
                                    title="Save changes"
                                    [disabled]="item.status === 'draft'">
                              <i class="fas fa-save"></i>
                            </button>
                          </td>
                        </tr>
                      }
                    </tbody>
                    @if (item.remarks) {
                      <tfoot>
                        <tr>
                          <td colspan="9" class="requisition-remarks">
                            <strong><i class="fas fa-comment"></i> Requisition Remarks:</strong> {{ item.remarks }}
                          </td>
                        </tr>
                      </tfoot>
                    }
                  </table>
                </div>
              </td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>

  @if (requisitionItems.length > itemsPerPage) {
    <div class="pagination">
      <button (click)="changePage(-1)" [disabled]="currentPage === 1">
        <i class="fas fa-chevron-left"></i> Previous
      </button>
      <span class="page-info">Page {{ currentPage }} of {{ totalPages }}</span>
      <button (click)="changePage(1)" [disabled]="currentPage === totalPages">
        Next <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  }
</div>