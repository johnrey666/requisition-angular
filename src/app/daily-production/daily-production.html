<div class="dashboard-container">
  <!-- SINGLE ROW CONTROLS -->
  <div class="single-row-controls">
    <!-- Table Management -->
    <div class="control-section">
      <div class="table-management-compact">
        <select class="form-select-sm" [(ngModel)]="selectedTableId" (change)="loadTableData()">
          <option value="">-- Select Table --</option>
          @for (table of userTables; track table.id) {
            <option [value]="table.id">{{ table.name }}</option>
          }
        </select>
        
        <button class="btn-sm btn-icon" (click)="createNewTable()" title="New Table">
          <i class="fas fa-plus"></i>
        </button>
        
        <button class="btn-sm btn-icon" [disabled]="!selectedTableId" (click)="renameTable()" title="Rename">
          <i class="fas fa-edit"></i>
        </button>
        
        <button class="btn-sm btn-danger" [disabled]="!selectedTableId" (click)="deleteTable()" title="Delete">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>

    <!-- Master File Upload -->
    <div class="control-section">
      <div class="file-upload-compact">
        <button class="btn-sm btn-icon" (click)="masterFileInput.click()" title="Upload Master File">
          <i class="fas fa-upload"></i> Master File
        </button>
        <input type="file" #masterFileInput id="masterFile" accept=".xlsx, .xls"
               (change)="onFileUpload($event)" style="display: none">
        <span class="file-status-sm" [class.has-file]="uploadedFileName" title="{{uploadedFileName || 'No file'}}">
          @if (uploadedFileName) {
            {{ uploadedFileName.length > 18 ? (uploadedFileName | slice:0:15) + '...' : uploadedFileName }}
          }
        </span>
        @if (uploadedFileName) {
          <button class="btn-clear-sm" (click)="clearFile()" title="Clear">
            <i class="fas fa-times"></i>
          </button>
        }
      </div>
    </div>

    <!-- Actions (Export, Print & Clear) -->
    <div class="control-section">
      <div class="action-buttons-compact">
        <button class="btn-sm btn-icon" 
                [disabled]="requisitionItems.length === 0" 
                (click)="printTable()"
                title="Print Table">
          <i class="fas fa-print"></i> Print
        </button>

        <div class="dropdown">
          <button class="btn-sm btn-icon" 
                  [disabled]="requisitionItems.length === 0" 
                  (click)="toggleExportDropdown()"
                  title="Export">
            <i class="fas fa-download"></i> Export
          </button>
          @if (isExportDropdownOpen) {
            <div class="dropdown-menu">
              <button (click)="exportData('all')"><i class="fas fa-file-excel"></i> All Data</button>
              <button (click)="exportData('pre-mix')"><i class="fas fa-flask"></i> Pre-mix</button>
              <button (click)="exportData('packaging')"><i class="fas fa-box"></i> Packaging</button>
              <button (click)="exportData('meat-veg')"><i class="fas fa-carrot"></i> Meat & Veg</button>
            </div>
          }
        </div>

        <button class="btn-sm btn-danger" (click)="clearAll()" [disabled]="!selectedTableId" title="Clear Table">
          <i class="fas fa-trash"></i> Clear
        </button>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <span class="stats">
      <i class="fas fa-table"></i> {{ currentTable?.name || 'No table selected' }}
      <span class="divider">•</span>
      <i class="fas fa-cube"></i> {{ filteredItems.length }} items
      <span class="divider">•</span>
      <i class="fas fa-database"></i> Auto-saved
    </span>
    @if (requisitionItems.length > itemsPerPage) {
      <span class="pagination-mini">
        <button class="btn-xs" (click)="changePage(-1)" [disabled]="currentPage === 1">
          <i class="fas fa-chevron-left"></i>
        </button>
        <span>Page {{ currentPage }}/{{ totalPages }}</span>
        <button class="btn-xs" (click)="changePage(1)" [disabled]="currentPage === totalPages">
          <i class="fas fa-chevron-right"></i>
        </button>
      </span>
    }
  </div>

  <!-- Compact Table with Controls in Header -->
  <div class="table-container-compact">
    <table class="compact-table">
      <thead>
        <tr>
          <th colspan="10" class="table-header-with-controls">
            <div class="table-controls-row">
              <!-- Left: Table Title -->
              <div class="table-title-section">
                <div class="table-title">
                  <i class="fas fa-list"></i> Requisition Items
                </div>
              </div>
              
              <!-- Center: Quick Add Form (category, sku, code, supplier, add) -->
              <div class="table-controls-section">
                <div class="quick-add-form" [formGroup]="requisitionForm">
                  <select class="form-select-xs" formControlName="category" (change)="onCategoryChange()" title="Category">
                    <option value="">Category</option>
                    @for (category of categories; track category) {
                      <option [value]="category">
                        @if (category && category.length > 12) {
                          {{ category | slice:0:12 }}...
                        } @else {
                          {{ category }}
                        }
                      </option>
                    }
                  </select>

                  <select class="form-select-xs" formControlName="sku" (change)="onSkuChange()" [disabled]="skus.length === 0" title="SKU">
                    <option value="">SKU</option>
                    @for (sku of skus; track sku.code) {
                      <option [value]="sku.name">
                        @if (sku.name && sku.name.length > 12) {
                          {{ sku.name | slice:0:12 }}...
                        } @else {
                          {{ sku.name }}
                        }
                      </option>
                    }
                  </select>

                  <input class="form-input-xs" type="text" formControlName="skuCode" placeholder="Code" readonly title="SKU Code">

                  <input class="form-input-xs" type="text" formControlName="supplier" placeholder="Supplier" title="Supplier">

                  <button class="btn-xs btn-primary" (click)="addRequisition()" [disabled]="requisitionForm.invalid || !selectedTableId" title="Add Item">
                    <i class="fas fa-plus"></i> Add
                  </button>
                </div>
              </div>
              
              <!-- Right: Search Box -->
              <div class="table-search-section">
                <div class="table-search-box">
                  <i class="fas fa-search"></i>
                  <input type="text" [(ngModel)]="searchQuery" (ngModelChange)="onSearch()" 
                         placeholder="Search items..." class="table-search-input">
                  <div class="search-actions">
                    <button class="btn-xs btn-icon" (click)="onSearch()" title="Search">
                      <i class="fas fa-search"></i>
                    </button>
                    @if (searchQuery) {
                      <button class="btn-xs btn-icon" (click)="searchQuery = ''; onSearch()" title="Clear Search">
                        <i class="fas fa-times"></i>
                      </button>
                    }
                  </div>
                </div>
              </div>
            </div>
          </th>
        </tr>
        <tr>
          <th style="width:28px;"></th>
          <th style="width:70px;" class="sortable" (click)="sortBy('skuCode')">Code</th>
          <th style="width:120px;" class="sortable" (click)="sortBy('skuName')">SKU</th>
          <th style="width:90px;" class="sortable" (click)="sortBy('category')">Category</th>
          <th style="width:60px;">Qty</th>
          <th style="width:100px;">Supplier</th>
          <th style="width:65px;">Qty/Unit</th>
          <th style="width:50px;">Unit</th>
          <th style="width:45px;">Mats</th>
          <th style="width:60px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        @if (filteredItems.length === 0) {
          <tr class="empty-row">
            <td colspan="10">
              <div class="empty-state-compact">
                <i class="fas fa-inbox"></i>
                <p>{{ searchQuery ? 'No matching items found' : 'No requisitions added yet' }}</p>
                @if (!selectedTableId) {
                  <p class="empty-hint">Select or create a table to start adding requisitions</p>
                }
              </div>
            </td>
          </tr>
        }

        @for (item of filteredItems; track item.id; let i = $index) {
          <tr [class.expanded]="expandedRows.has(item.id)">
            <td>
              <button class="toggle-btn-sm" (click)="toggleRow(item.id)">
                <i class="fas" [class.fa-chevron-up]="expandedRows.has(item.id)" [class.fa-chevron-down]="!expandedRows.has(item.id)"></i>
              </button>
            </td>
            <td><strong>{{ item.skuCode }}</strong></td>
            <td class="truncate">
              @if (item.skuName && item.skuName.length > 20) {
                {{ item.skuName | slice:0:20 }}...
              } @else {
                {{ item.skuName }}
              }
            </td>
            <td><span class="category-tag">{{ item.category || 'Uncategorized' }}</span></td>
            <td>
              <input type="number" class="qty-input-sm" min="1" max="99"
                     [value]="item.qtyNeeded"
                     (change)="updateQty(item.id, $any($event.target).value)">
            </td>
            <td>
              <input type="text" class="supplier-input-sm"
                     [value]="item.supplier || ''"
                     (change)="updateSupplier(item.id, $any($event.target).value)"
                     placeholder="Supplier">
            </td>
            <td class="numeric">{{ item.qtyPerUnit || '-' }}</td>
            <td class="unit">{{ item.unit || '-' }}</td>
            <td class="numeric">{{ item.materials ? item.materials.length : 0 }}</td>
            <td>
              <div class="action-icons">
                <button class="icon-btn-xs btn-delete" (click)="deleteItem(item.id)" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>

          <!-- Expanded Details -->
          @if (expandedRows.has(item.id)) {
            <tr class="details-row">
              <td colspan="10">
                <div class="details-compact">
                  <div class="details-header">
                    <h5><i class="fas fa-list"></i> Materials ({{ item.materials ? item.materials.length : 0 }})</h5>
                    <select class="filter-select" #typeFilter (change)="filterMaterials(item.id, typeFilter.value)">
                      <option value="">All Types</option>
                      <option value="pre-mix">Pre-mix</option>
                      <option value="packaging">Packaging</option>
                      <option value="meat-veg">Meat & Veg</option>
                    </select>
                  </div>
                  
                  <div class="materials-grid">
                    @if (item.materials && getFilteredMaterials(item.id, item.materials).length > 0) {
                      @for (material of getFilteredMaterials(item.id, item.materials); track $index) {
                        <div class="material-card" [class.unserved]="material.isUnserved">
                          <div class="material-header">
                            <span class="material-name">
                              @if (material.name && material.name.length > 25) {
                                {{ material.name | slice:0:25 }}...
                              } @else {
                                {{ material.name }}
                              }
                            </span>
                            <span class="material-type">{{ material.type || 'N/A' }}</span>
                          </div>
                          <div class="material-details">
                            <div class="detail">
                              <label>Required:</label>
                              <span>{{ material.requiredQty }} {{ material.unit }}</span>
                            </div>
                            <div class="detail">
                              <label>Served:</label>
                              <input type="number" class="served-input-sm"
                                     [value]="material.servedQty || 0"
                                     min="0" [max]="material.requiredQty"
                                     (change)="updateMaterialServedQty(item.id, $index, $any($event.target).value)">
                            </div>
                          </div>
                          <div class="material-actions">
                            <input type="text" class="remarks-input-sm"
                                   [value]="material.remarks || ''"
                                   placeholder="Remarks"
                                   (change)="updateMaterialServedQty(item.id, $index, material.servedQty || 0, $any($event.target).value)">
                            <button class="btn-xs" 
                                    (click)="updateMaterialServedQty(item.id, $index, material.servedQty || 0, material.remarks)">
                              <i class="fas fa-save"></i>
                            </button>
                          </div>
                        </div>
                      }
                    } @else {
                      <div class="no-materials">
                        <i class="fas fa-box-open"></i>
                        <p>No materials found</p>
                      </div>
                    }
                  </div>
                  
                  @if (item.remarks) {
                    <div class="requisition-remarks">
                      <strong><i class="fas fa-comment"></i> Remarks:</strong> {{ item.remarks }}
                    </div>
                  }
                </div>
              </td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>

  <!-- Modern Snackbar -->
  @if (showSnackbar) {
    <div class="snackbar" [class]="'snackbar-' + snackbarType">
      <div class="snackbar-content">
        <i class="fas" [class]="getSnackbarIcon()"></i>
        <span class="snackbar-message">{{ snackbarMessage }}</span>
      </div>
      <button class="snackbar-close" (click)="hideSnackbar()">
        <i class="fas fa-times"></i>
      </button>
    </div>
  }
</div>