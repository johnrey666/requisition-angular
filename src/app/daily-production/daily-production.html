<div class="dashboard-container">
  <!-- SINGLE ROW CONTROLS -->
  <div class="single-row-controls">
    <!-- Table Management -->
    <div class="control-section">
      <div class="table-management-compact">
        <select class="form-select-sm" [(ngModel)]="selectedTableId" (change)="loadTableData()">
          <option value="">-- Select Table --</option>
          <option *ngFor="let table of userTables" [value]="table.id">{{ table.name }}</option>
        </select>
        
        <button class="btn-sm btn-icon" (click)="createNewTable()" title="New Table">
          <i class="fas fa-plus"></i>
        </button>
        
        <button class="btn-sm btn-icon" [disabled]="!selectedTableId" (click)="renameTable()" title="Rename">
          <i class="fas fa-edit"></i>
        </button>
        
        <button class="btn-sm btn-danger" [disabled]="!selectedTableId" (click)="deleteTable()" title="Delete">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>

    <!-- Master File Upload -->
    <div class="control-section">
      <div class="file-upload-compact">
        <button class="btn-sm btn-icon" (click)="masterFileInput.click()" title="Upload Master File">
          <i class="fas fa-upload"></i> Master
        </button>
        <input type="file" #masterFileInput id="masterFile" accept=".xlsx, .xls"
               (change)="onFileUpload($event)" style="display: none">
        <span class="file-status-sm" [class.has-file]="uploadedFileName" [title]="uploadedFileName || 'No file'">
          <span *ngIf="uploadedFileName">
            {{ uploadedFileName.length > 20 ? (uploadedFileName | slice:0:18) + '...' : uploadedFileName }}
          </span>
          <span *ngIf="!uploadedFileName">No file</span>
        </span>
        <button *ngIf="uploadedFileName" class="btn-clear-sm" (click)="clearFile()" title="Clear">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <!-- Actions (Export, Print & Clear) -->
    <div class="control-section">
      <div class="action-buttons-compact">
        <button class="btn-sm btn-icon" 
                [disabled]="requisitionItems.length === 0" 
                (click)="printTable()"
                title="Print Table">
          <i class="fas fa-print"></i> Print
        </button>

        <div class="dropdown">
          <button class="btn-sm btn-icon" 
                  [disabled]="requisitionItems.length === 0" 
                  (click)="toggleExportDropdown()"
                  title="Export">
            <i class="fas fa-download"></i> Export
          </button>
          <div *ngIf="isExportDropdownOpen" class="dropdown-menu">
            <button (click)="exportData('all')"><i class="fas fa-file-excel"></i> All Data</button>
            <button (click)="exportData('pre-mix')"><i class="fas fa-flask"></i> Pre-mix</button>
            <button (click)="exportData('packaging')"><i class="fas fa-box"></i> Packaging</button>
            <button (click)="exportData('meat-veg')"><i class="fas fa-carrot"></i> Meat & Veg</button>
          </div>
        </div>

        <button class="btn-sm btn-danger" (click)="clearAll()" [disabled]="!selectedTableId" title="Clear Table">
          <i class="fas fa-trash"></i> Clear
        </button>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <span class="stats">
      <i class="fas fa-table"></i> {{ currentTable?.name || 'No table selected' }}
      <span class="divider">•</span>
      <i class="fas fa-cube"></i> {{ filteredItems.length }} items
      <span class="divider">•</span>
      <i class="fas fa-database"></i> Auto-saved
    </span>
    <span *ngIf="requisitionItems.length > itemsPerPage" class="pagination-mini">
      <button class="btn-xs" (click)="changePage(-1)" [disabled]="currentPage === 1">
        <i class="fas fa-chevron-left"></i>
      </button>
      <span>Page {{ currentPage }}/{{ totalPages }}</span>
      <button class="btn-xs" (click)="changePage(1)" [disabled]="currentPage === totalPages">
        <i class="fas fa-chevron-right"></i>
      </button>
    </span>
  </div>

  <!-- Compact Table with Controls in Header -->
  <div class="table-container-compact">
    <table class="compact-table">
      <thead>
        <tr>
          <th colspan="12" class="table-header-with-controls">
            <div class="table-controls-row">
              <!-- Left: Table Title -->
              <div class="table-title-section">
                <div class="table-title">
                  <i class="fas fa-list"></i> Requisition Items
                </div>
              </div>
              
              <!-- Center: Quick Add Form (category, sku, code, supplier, add) -->
              <div class="table-controls-section">
                <div class="quick-add-form" [formGroup]="requisitionForm">
                  <select class="form-select-xs" formControlName="category" (change)="onCategoryChange()" title="Category">
                    <option value="">Category</option>
                    <option *ngFor="let category of categories" [value]="category">
                      {{ (category && category.length > 15) ? (category | slice:0:14) + '...' : category }}
                    </option>
                  </select>

                  <select class="form-select-xs sku-select" formControlName="sku" (change)="onSkuChange()" [disabled]="skus.length === 0" title="SKU">
                    <option value="">SKU</option>
                    <option *ngFor="let sku of skus" [value]="sku.name" [title]="sku.name">
                      {{ (sku.name && sku.name.length > 20) ? (sku.name | slice:0:19) + '...' : sku.name }}
                    </option>
                  </select>

                  <input class="form-input-xs sku-code" type="text" formControlName="skuCode" placeholder="Code" readonly title="SKU Code">

                  <input class="form-input-xs supplier-input" type="text" formControlName="supplier" placeholder="Supplier" title="Supplier">

                  <button class="btn-xs btn-primary add-btn" (click)="addRequisition()" 
                          [disabled]="requisitionForm.invalid || !selectedTableId" title="Add Item">
                    <i class="fas fa-plus"></i> Add
                  </button>
                </div>
              </div>
              
              <!-- Right: Search Box -->
              <div class="table-search-section">
                <div class="table-search-box">
                  <i class="fas fa-search search-icon"></i>
                  <input type="text" [(ngModel)]="searchQuery" (ngModelChange)="onSearch()" 
                         placeholder="Search..." class="table-search-input">
                  <button *ngIf="searchQuery" class="btn-xs btn-clear-search" (click)="searchQuery = ''; onSearch()" title="Clear Search">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </th>
        </tr>
        <tr>
          <th style="width:28px;"></th>
          <th style="width:70px;" class="sortable" (click)="sortBy('skuCode')">Code</th>
          <th style="width:180px;" class="sortable" (click)="sortBy('skuName')">SKU</th>
          <th style="width:100px;" class="sortable" (click)="sortBy('category')">Category</th>
          <th style="width:50px;">Qty</th>
          <th style="width:120px;">Supplier</th>
          <th style="width:65px;">Qty/Unit</th>
          <th style="width:50px;">Unit</th>
          <th style="width:65px;">Qty/Pack</th>
          <th style="width:60px;">Pack Unit</th>
          <th style="width:45px;">Mats</th>
          <th style="width:60px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngIf="filteredItems.length === 0" class="empty-row">
          <td colspan="12">
            <div class="empty-state-compact">
              <i class="fas fa-inbox"></i>
              <p>{{ searchQuery ? 'No matching items found' : 'No requisitions added yet' }}</p>
              <p *ngIf="!selectedTableId" class="empty-hint">Select or create a table to start</p>
            </div>
          </td>
        </tr>

        <ng-container *ngFor="let item of filteredItems">
          <tr [class.expanded]="expandedRows.has(item.id)">
            <td>
              <button class="toggle-btn-sm" (click)="toggleRow(item.id)">
                <i class="fas" [class.fa-chevron-up]="expandedRows.has(item.id)" [class.fa-chevron-down]="!expandedRows.has(item.id)"></i>
              </button>
            </td>
            <td><strong class="sku-code-display">{{ item.skuCode }}</strong></td>
            <td class="truncate sku-name-display" [title]="item.skuName">
              {{ item.skuName }}
            </td>
            <td><span class="category-tag">{{ item.category || 'Uncategorized' }}</span></td>
            <td>
              <input type="number" class="qty-input-sm" min="1" max="99"
                     [value]="item.qtyNeeded"
                     (change)="updateQty(item.id, $any($event.target).value)">
            </td>
            <td>
              <input type="text" class="supplier-input-sm"
                     [value]="item.supplier || ''"
                     (change)="updateSupplier(item.id, $any($event.target).value)"
                     placeholder="Supplier">
            </td>
            <td class="numeric">{{ item.qtyPerUnit || '-' }}</td>
            <td class="unit">{{ item.unit || '-' }}</td>
            <td class="numeric">{{ item.qtyPerPack || '-' }}</td>
            <td class="unit">{{ item.unit2 || '-' }}</td>
            <td class="numeric"><span class="mats-badge">{{ item.materials ? item.materials.length : 0 }}</span></td>
            <td>
              <div class="action-icons">
                <button class="icon-btn-xs btn-delete" (click)="deleteItem(item.id)" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>

          <!-- Expanded Details -->
          <tr *ngIf="expandedRows.has(item.id)" class="details-row">
            <td colspan="12">
              <div class="details-compact">
                <div class="details-header">
                  <h5><i class="fas fa-list"></i> Materials ({{ item.materials ? item.materials.length : 0 }})</h5>
                  <select class="filter-select" #typeFilter (change)="filterMaterials(item.id, typeFilter.value)">
                    <option value="">All Types</option>
                    <option value="pre-mix">Pre-mix</option>
                    <option value="packaging">Packaging</option>
                    <option value="meat-veg">Meat & Veg</option>
                  </select>
                </div>
                
                <div class="materials-table-container">
                  <table class="materials-table">
                    <thead>
                      <tr>
                        <th>Raw Material</th>
                        <th>Qty/Batch</th>
                        <th>Unit</th>
                        <th>Type</th>
                        <th>Total Required</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngIf="item.materials && getFilteredMaterials(item.id, item.materials).length === 0">
                        <td colspan="5" class="no-materials-cell">
                          <div class="no-materials">
                            <i class="fas fa-box-open"></i>
                            <p>No materials found</p>
                          </div>
                        </td>
                      </tr>
                      <tr *ngFor="let material of getFilteredMaterials(item.id, item.materials)">
                        <td class="material-name-cell">
                          <strong>{{ material.name }}</strong>
                        </td>
                        <td class="numeric">{{ material.qty }}</td>
                        <td class="unit">{{ material.unit || '-' }}</td>
                        <td>
                          <span class="material-type-tag">{{ material.type || 'N/A' }}</span>
                        </td>
                        <td class="numeric total-required">
                          <strong>{{ material.requiredQty }} {{ material.unit || '' }}</strong>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>

  <!-- Modern Snackbar -->
  <div *ngIf="showSnackbar" class="snackbar" [ngClass]="'snackbar-' + snackbarType">
    <div class="snackbar-content">
      <i class="fas" [ngClass]="getSnackbarIcon()"></i>
      <span class="snackbar-message">{{ snackbarMessage }}</span>
    </div>
    <button class="snackbar-close" (click)="hideSnackbar()">
      <i class="fas fa-times"></i>
    </button>
  </div>
</div>